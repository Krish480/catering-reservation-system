<!-- cart.ejs -->
<%- include("../partials/header") %>

<section class="container mx-auto py-16 px-6">
  <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Your Cart</h2>
  <div id="cart-container" class="space-y-4"></div>

  <div id="checkout-area" class="text-center mt-8">
    <p id="cart-total" class="text-xl font-semibold mb-4"></p>
    <button id="checkout-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">Checkout</button>
  </div>
</section>

<%- include("../partials/footer") %>

<script>
  let cart = JSON.parse(localStorage.getItem('cart')) || [];

  function renderCart(){
    const container = document.getElementById('cart-container');
    container.innerHTML = '';

    if(cart.length === 0){
      container.innerHTML = "<p class='text-center text-gray-600'>Your cart is empty ðŸ›’</p>";
      document.getElementById('cart-total').textContent = '';
      return;
    }

    cart.forEach(item => {
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between bg-white p-4 rounded-lg shadow-md';

      const left = document.createElement('div');
      left.className = 'flex items-center gap-4';
      const img = document.createElement('img');
      img.src = item.imageUrl; img.className = 'w-20 h-20 object-cover rounded-md';
      const info = document.createElement('div');
      info.innerHTML = `<h3 class="font-semibold">${item.name}</h3><p>â‚¹${item.price}</p>`;
      left.appendChild(img); left.appendChild(info);

      const right = document.createElement('div');
      right.className = 'flex items-center gap-4';
      const qtyBox = document.createElement('div');
      qtyBox.className = 'flex items-center gap-2';
      const minus = document.createElement('button'); minus.textContent = '-';
      minus.className = 'px-2 py-1 bg-gray-200 rounded';
      minus.addEventListener('click', ()=> changeQty(item.id, -1));
      const qty = document.createElement('span'); qty.textContent = item.quantity;
      const plus = document.createElement('button'); plus.textContent = '+';
      plus.className = 'px-2 py-1 bg-gray-200 rounded';
      plus.addEventListener('click', ()=> changeQty(item.id, +1));
      qtyBox.appendChild(minus); qtyBox.appendChild(qty); qtyBox.appendChild(plus);

      const remove = document.createElement('button');
      remove.className = 'text-red-500';
      remove.textContent = 'Remove';
      remove.addEventListener('click', ()=> removeFromCart(item.id));

      right.appendChild(qtyBox); right.appendChild(remove);

      row.appendChild(left); row.appendChild(right);
      container.appendChild(row);
    });

    updateTotal();
  }

  function changeQty(id, delta){
    const it = cart.find(x => String(x.id)===String(id));
    if(!it) return;
    it.quantity = (it.quantity||1) + delta;
    if(it.quantity <= 0) {
      cart = cart.filter(x=> String(x.id) !== String(id));
    }
    localStorage.setItem('cart', JSON.stringify(cart));
    renderCart();
    // also update header count (if header present)
    if(window.updateCartCount) window.updateCartCount();
  }

  function removeFromCart(id){
    cart = cart.filter(x => String(x.id) !== String(id));
    localStorage.setItem('cart', JSON.stringify(cart));
    renderCart();
    if(window.updateCartCount) window.updateCartCount();
  }

  function updateTotal(){
    const total = cart.reduce((s,i)=> s + (i.price * (i.quantity||1)), 0);
    document.getElementById('cart-total').textContent = 'Total: â‚¹' + total;
  }

  document.getElementById('checkout-btn').addEventListener('click', ()=> {
    if(cart.length === 0) return alert('Cart is empty');
    // For now just clear and show message. Later post to server.
    alert('Checkout demo: Order placed (demo).');
    cart = [];
    localStorage.removeItem('cart');
    renderCart();
    if(window.updateCartCount) window.updateCartCount();
  });

  // INIT
  document.addEventListener('DOMContentLoaded', renderCart);
</script>
